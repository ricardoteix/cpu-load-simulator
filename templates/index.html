<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>CPU Load Simulator</title>

        <script>
            let running = "{{ running }}" == "True";
            let runningStart = Math.floor(Number("{{ running_start }}"));
            let runningEnd = Math.floor(Number("{{ running_end }}"));
            let numCores = {{ num_cores - 1 }};
            console.log("num_cores", {{ num_cores - 1 }});
        </script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    </head>
    <body>
        <div class="container mt-5">
            <div class="row text-center">
                <div class="col">
                    <h1>Gerar Carga na CPU</h1>
                    <h3>{{ ec2_instance_id }}</h3>
                </div>
            </div>
            <form>
                <div class="mb-3" hidden>
                    <label for="cores" class="form-label" id="coresLabel">CPU Cores (0/{{ num_cores - 1 }})</label>
                    <input onchange="onChangeCores()"
                           onmousemove="onChangeCores()"
                           type="range" min="0" max="{{ num_cores - 1 }}" value="{{ cores }}" class="form-control" id="cores">
                </div>
                <div class="mb-3">
                    <label for="perc" class="form-label" id="percLabel">Percentual (%)</label>
                    <input onchange="onChangePercentual()"
                           onmousemove="onChangePercentual()"
                           type="range" min="5" max="100" value="{{ perc }}" class="form-control" id="perc">
                </div>
                <div class="mb-3">
                    <label for="duration" class="form-label" id="durationLabel">Duração (s)</label>
                    <input onchange="onChangePercentual()"
                           onmousemove="onChangeDuration()"
                           type="range" min="10" max="300"
                           step="10" value="{{ duration }}" class="form-control" id="duration">
                </div>

                <button onclick="runSimulation()" type="button" id="simulate" class="btn btn-primary">Gerar</button>
            </form>
            <div class="row mt-3">
                <div class="column">
                    <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script src="{{url_for('static', filename='index.js')}}"></script>

    <!--<script>

        let btnSimulate = document.getElementById("simulate");
        let responseBody = {}

        document.getElementById("cores").value = "{{ cores }}";
        document.getElementById("perc").value = "{{ perc }}";
        document.getElementById("duration").value = "{{ duration }}";

        let coresValue = document.getElementById("cores").value;
        let percValue = document.getElementById("perc").value;
        let durationValue = document.getElementById("duration").value;
        let intervalId = 0;

        let running = "{{ running }}" == "True";
        let runningStart = Math.floor(Number("{{ running_start }}"));
        let runningEnd = Math.floor(Number("{{ running_end }}"));

        runSimulation();

        if (running) {
            updateProgress();
        }
        console.log(running, runningStart, runningEnd);

        onChangePercentual();
        onChangeDuration();
        onChangeCores();

        function onChangeCores() {
            coresValue = document.getElementById("cores").value;
            let coresLabel = document.getElementById("coresLabel");
            coresLabel.innerText = `Cores (${coresValue}/{{ num_cores - 1 }})`;
        }

        function onChangePercentual() {
            percValue = document.getElementById("perc").value;
            let percLabel = document.getElementById("percLabel");
            percLabel.innerText = `Percentual (${percValue}%)`;
        }

        function onChangeDuration() {
            durationValue = document.getElementById("duration").value;
            let durationLabel = document.getElementById("durationLabel");
            durationLabel.innerText = `Duration (${durationValue}s)`;
        }

        function runSimulation() {
            coresValue = document.getElementById("cores").value;
            percValue = document.getElementById("perc").value;
            durationValue = document.getElementById("duration").value;

            running = true;

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", (data) => {
              if(xhr.readyState === 4) {
                console.log(data);
                responseBody = JSON.parse(xhr.responseText);
                console.log(responseBody);
              }
            });

            const url = `/api/cpu-load/cores/${coresValue}/perc/${percValue}/duration/${durationValue}`;
            xhr.open("GET", url);

            xhr.send();

            updateProgress();
        }

        function updateProgress() {

            document.getElementById('simulate').disabled = running;
            document.getElementById('perc').disabled = running;
            document.getElementById('duration').disabled = running;
            document.getElementById('cores').disabled = running;
            clearInterval(intervalId);

            now = new Date().getTime();

            if (!running) {
                runningStart = now;
            }

            runningEnd = now + Number(durationValue);

            console.log("now", now);
            console.log("runningStart", runningStart);
            timePassed = now - runningStart;


            console.log("timePassed", timePassed);

            intervalId = setInterval(
                () => {
                    timePassed++;
                    let progressPerc = 100 - Math.round(timePassed / (durationValue) * 100);
                    document.getElementsByClassName('progress-bar')[0].style.width = `${progressPerc}%`;
                    console.log("progressPerc", progressPerc);
                    if (progressPerc <= 0) {
                        clearInterval(intervalId);

                        document.getElementById('simulate').disabled = false;
                        document.getElementById('perc').disabled = false;
                        document.getElementById('duration').disabled = false;
                        document.getElementById('cores').disabled = false;

                        running = false;
                        runningEnd = 0;
                        runningStart = 0;
                    }
                },
                1000
            );
        }

    </script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</html>